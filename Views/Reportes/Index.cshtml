@{
    ViewData["Title"] = "Reportes de Productos";
}

<div class="container mt-4">
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
            <h4><i class="bi bi-file-earmark-bar-graph"></i> Reporte de Productos</h4>
        </div>
        <div class="card-body">
            <form id="formFiltros" class="row g-2 mb-3">
                <div class="col-md-4">
                    <input type="text" class="form-control" name="nombre" placeholder="Filtrar por nombre" />
                </div>
                <div class="col-md-4">
                    <input type="number" step="0.01" class="form-control" name="precio" placeholder="Filtrar por precio máximo" />
                </div>
                <div class="col-md-4 d-flex gap-2">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-funnel"></i> Filtrar
                    </button>
                    <button id="btnGenerarPDF" type="button" class="btn btn-danger">
                        <i class="bi bi-file-earmark-pdf"></i> Generar PDF
                    </button>
                    <button id="btnGenerarCSV" type="button" class="btn btn-success">
                        <i class="bi bi-file-earmark-spreadsheet"></i> Generar CSV
                    </button>
                </div>
            </form>

            <div id="contenedorReporte" class="table-responsive">
                @* Aquí se insertará la tabla con los productos *@
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script>
        $(document).ready(function () {
            // Filtrar con AJAX
            $("#formFiltros").on("submit", function (e) {
                e.preventDefault();
                $.ajax({
                    url: '@Url.Action("ObtenerReporte", "Reportes")',
                    method: 'POST',
                    data: $(this).serialize(),
                    success: function (html) {
                        $("#contenedorReporte").html(html);
                    }
                });
            });

            // Generar PDF
            $("#btnGenerarPDF").on("click", function () {
                const doc = new jspdf.jsPDF();
                doc.text("Reporte de Productos", 14, 16);
                doc.autoTable({ html: '#tablaReporte', startY: 20 });
                doc.save('reporte-productos.pdf');
            });

            // Generar CSV
            $("#btnGenerarCSV").on("click", function () {
                const filas = document.querySelectorAll("#tablaReporte tbody tr");
                if (filas.length === 0) return;

                let csv = "ID,Nombre,Precio,Stock\n";
                filas.forEach(fila => {
                    const celdas = fila.querySelectorAll("td");
                    const filaCSV = Array.from(celdas).map(td => `"${td.innerText}"`).join(",");
                    csv += filaCSV + "\n";
                });

                const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = "reporte-productos.csv";
                link.click();
            });
        });
    </script>
}
